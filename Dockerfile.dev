# Development Dockerfile with all tools and dependencies
FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache \
    libc6-compat \
    git \
    curl \
    bash \
    openssh-client \
    python3 \
    py3-pip \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

# Install Supabase CLI
RUN curl -L https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | \
    tar -xz -C /usr/local/bin/ && \
    chmod +x /usr/local/bin/supabase

# Install global npm packages for development
RUN npm install -g \
    typescript \
    tsx \
    nodemon \
    @types/node \
    eslint \
    prettier

# Set working directory
WORKDIR /app

# Copy package files
COPY package.json package-lock.json* ./

# Install all dependencies (including dev dependencies)
RUN npm ci

# Copy source code
COPY . .

# Create necessary directories
RUN mkdir -p .next uploads public/uploads coverage-reports .artifacts

# Set proper permissions
RUN chown -R node:node /app

# Switch to non-root user
USER node

# Expose ports
EXPOSE 3000 9229

# Default command
CMD ["npm", "run", "dev"]